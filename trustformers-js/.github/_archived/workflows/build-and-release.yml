name: Build and Release

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '18'
  RUST_VERSION: 'stable'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint

      - name: Format check
        run: npm run format -- --check

      - name: Run tests
        run: npm test

      - name: Check bundle size
        run: npm run test:size

  build-wasm:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: rust-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build WASM module
        run: |
          cd ../trustformers-wasm
          wasm-pack build --target web --out-dir ../trustformers-js/pkg --release

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v3
        with:
          name: wasm-pkg
          path: pkg/
          retention-days: 1

  build-js:
    runs-on: ubuntu-latest
    needs: [lint-and-test, build-wasm]
    strategy:
      matrix:
        build-type: [development, production]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download WASM artifacts
        uses: actions/download-artifact@v3
        with:
          name: wasm-pkg
          path: pkg/

      - name: Build JavaScript bundles
        run: |
          if [ "${{ matrix.build-type }}" = "production" ]; then
            npm run build:prod
          else
            npm run build:dev
          fi

      - name: Analyze bundle size
        if: matrix.build-type == 'production'
        run: |
          npm run size-check
          npm run analyze

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: js-dist-${{ matrix.build-type }}
          path: |
            dist/
            !dist/**/*.map
          retention-days: 7

      - name: Upload source maps
        if: matrix.build-type == 'production'
        uses: actions/upload-artifact@v3
        with:
          name: source-maps
          path: dist/**/*.map
          retention-days: 30

  test-build:
    runs-on: ubuntu-latest
    needs: build-js
    strategy:
      matrix:
        node-version: [16, 18, 20]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Download production build
        uses: actions/download-artifact@v3
        with:
          name: js-dist-production
          path: dist/

      - name: Test installation
        run: |
          npm pack
          npm install -g trustformers-*.tgz
          node -e "console.log('Testing require:', require('trustformers'))"
          node -e "import('trustformers').then(m => console.log('Testing import:', m))"

  cross-browser-test:
    runs-on: ubuntu-latest
    needs: build-js
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Download production build
        uses: actions/download-artifact@v3
        with:
          name: js-dist-production
          path: dist/

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run cross-browser tests
        run: npx playwright test

  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run security audit
        run: npm audit --audit-level moderate

      - name: Check for known vulnerabilities
        run: |
          npx snyk test --severity-threshold=medium || true
          npx retire --exitwith 1 || true

  release:
    runs-on: ubuntu-latest
    needs: [test-build, cross-browser-test, security-audit]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Download production build
        uses: actions/download-artifact@v3
        with:
          name: js-dist-production
          path: dist/

      - name: Generate changelog
        run: |
          npx conventional-changelog-cli -p angular -i CHANGELOG.md -s
          git add CHANGELOG.md

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}

      - name: Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Deploy to CDN
        run: npm run cdn:deploy
        env:
          CDN_API_KEY: ${{ secrets.CDN_API_KEY }}

      - name: Update documentation
        run: |
          npm run docs:build
          npm run docs:deploy
        env:
          DOCS_DEPLOY_KEY: ${{ secrets.DOCS_DEPLOY_KEY }}

  notify:
    runs-on: ubuntu-latest
    needs: release
    if: always()
    steps:
      - name: Notify on success
        if: needs.release.result == 'success'
        run: |
          echo "✅ Release successful!"
          # Add webhook notification here if needed

      - name: Notify on failure
        if: needs.release.result == 'failure'
        run: |
          echo "❌ Release failed!"
          # Add webhook notification here if needed