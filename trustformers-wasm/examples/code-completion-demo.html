<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrustformeRS Code Completion Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            color: #64ffda;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(100, 255, 218, 0.1);
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            min-height: calc(100vh - 160px);
        }

        .editor-area {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .editor-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .language-selector {
            padding: 8px 12px;
            background: rgba(100, 255, 218, 0.1);
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 6px;
            color: #64ffda;
            font-size: 14px;
        }

        .editor-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            width: 60px;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            padding: 20px 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            user-select: none;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .code-editor {
            flex: 1;
            padding: 20px 20px 20px 80px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            background: transparent;
            border: none;
            outline: none;
            color: #e0e0e0;
            resize: none;
            white-space: pre;
            overflow-wrap: normal;
            word-break: normal;
        }

        .code-editor::placeholder {
            color: #666;
        }

        .suggestion-popup {
            position: absolute;
            background: rgba(30, 30, 46, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 8px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background: rgba(100, 255, 218, 0.1);
        }

        .suggestion-title {
            font-weight: 600;
            color: #64ffda;
            margin-bottom: 4px;
        }

        .suggestion-description {
            font-size: 0.9rem;
            color: #aaa;
        }

        .suggestion-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .type-function { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        .type-variable { background: rgba(74, 144, 226, 0.2); color: #4a90e2; }
        .type-class { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .type-keyword { background: rgba(156, 39, 176, 0.2); color: #9c27b0; }

        .controls-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: #64ffda;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(100, 255, 218, 0.3);
            padding-bottom: 8px;
        }

        .model-selector {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .model-selector option {
            background: #1a1a2e;
            color: #e0e0e0;
        }

        .action-btn {
            background: linear-gradient(135deg, #64ffda 0%, #1de9b6 100%);
            color: #1a1a2e;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(100, 255, 218, 0.3);
        }

        .action-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .secondary-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .templates-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .template-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .template-item:hover {
            background: rgba(100, 255, 218, 0.1);
            border-color: rgba(100, 255, 218, 0.3);
        }

        .template-title {
            font-weight: 600;
            color: #64ffda;
            margin-bottom: 4px;
        }

        .template-description {
            font-size: 0.85rem;
            color: #aaa;
        }

        .metrics-display {
            background: rgba(100, 255, 218, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(100, 255, 218, 0.2);
        }

        .metrics-display h3 {
            margin-bottom: 10px;
            color: #64ffda;
            border: none;
            padding: 0;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .metric-value {
            color: #64ffda;
            font-weight: 600;
        }

        .settings-group {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group {
            margin-bottom: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #e0e0e0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #64ffda;
        }

        .slider-container {
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #e0e0e0;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #64ffda;
            cursor: pointer;
        }

        .progress-indicator {
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #64ffda, #1de9b6);
            width: 0%;
            transition: width 0.3s ease;
        }

        .completion-stats {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #aaa;
            text-align: center;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .controls-panel {
                max-height: 400px;
            }
        }

        /* Syntax highlighting */
        .keyword { color: #c792ea; }
        .string { color: #c3e88d; }
        .comment { color: #546e7a; }
        .number { color: #f78c6c; }
        .function { color: #82aaff; }
        .variable { color: #eeffff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíª TrustformeRS Code Completion Demo</h1>
            <p>Intelligent code completion with specialized language models</p>
            <div class="status-bar">
                <span id="model-status">Model: Not loaded</span>
                <span id="device-info">Device: Detecting...</span>
                <span id="memory-info">Memory: 0 MB</span>
            </div>
        </div>

        <div class="main-content">
            <div class="editor-area">
                <div class="editor-header">
                    <span>üìù Code Editor</span>
                    <select id="language-selector" class="language-selector">
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                        <option value="typescript">TypeScript</option>
                        <option value="rust">Rust</option>
                        <option value="cpp">C++</option>
                        <option value="java">Java</option>
                        <option value="go">Go</option>
                        <option value="sql">SQL</option>
                    </select>
                </div>
                
                <div class="editor-container">
                    <div class="line-numbers" id="line-numbers">1</div>
                    <textarea 
                        id="code-editor" 
                        class="code-editor" 
                        placeholder="Start typing your code here..."
                        spellcheck="false"
                    ></textarea>
                    
                    <div class="suggestion-popup" id="suggestion-popup">
                        <!-- Suggestions will be populated here -->
                    </div>
                </div>
                
                <div class="progress-indicator">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="completion-stats" id="completion-stats">
                        Ready for code completion
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="control-group">
                    <h3>Model Configuration</h3>
                    <select id="model-select" class="model-selector">
                        <option value="codellama-7b">CodeLlama 7B</option>
                        <option value="codellama-13b">CodeLlama 13B</option>
                        <option value="starcoder-15b">StarCoder 15B</option>
                        <option value="deepseek-coder-6.7b">DeepSeek Coder 6.7B</option>
                        <option value="qwen-coder-7b">Qwen2.5-Coder 7B</option>
                        <option value="code-t5-plus">CodeT5+ 770M</option>
                    </select>
                    
                    <button id="complete-btn" class="action-btn">Complete Code</button>
                    <button id="explain-btn" class="action-btn secondary-btn">Explain Code</button>
                    <button id="optimize-btn" class="action-btn secondary-btn">Optimize Code</button>
                </div>

                <div class="control-group">
                    <h3>Code Templates</h3>
                    <div class="templates-grid">
                        <div class="template-item" data-template="python-function">
                            <div class="template-title">Python Function</div>
                            <div class="template-description">Basic function template</div>
                        </div>
                        <div class="template-item" data-template="python-class">
                            <div class="template-title">Python Class</div>
                            <div class="template-description">Class with init method</div>
                        </div>
                        <div class="template-item" data-template="javascript-function">
                            <div class="template-title">JavaScript Function</div>
                            <div class="template-description">Modern async function</div>
                        </div>
                        <div class="template-item" data-template="rust-struct">
                            <div class="template-title">Rust Struct</div>
                            <div class="template-description">Struct with impl block</div>
                        </div>
                        <div class="template-item" data-template="sql-query">
                            <div class="template-title">SQL Query</div>
                            <div class="template-description">SELECT statement</div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Completion Settings</h3>
                    <div class="settings-group">
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Temperature</span>
                                <span id="temperature-value">0.2</span>
                            </div>
                            <input type="range" id="temperature-slider" class="slider" min="0" max="1" step="0.1" value="0.2">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Max Length</span>
                                <span id="max-length-value">100</span>
                            </div>
                            <input type="range" id="max-length-slider" class="slider" min="10" max="500" step="10" value="100">
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="auto-complete" checked>
                                Auto-completion
                            </label>
                        </div>
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="syntax-highlighting" checked>
                                Syntax Highlighting
                            </label>
                        </div>
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="fill-in-middle">
                                Fill-in-the-Middle
                            </label>
                        </div>
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="multi-line" checked>
                                Multi-line Completion
                            </label>
                        </div>
                    </div>
                </div>

                <div class="metrics-display">
                    <h3>Performance Metrics</h3>
                    <div class="metric-item">
                        <span>Completion Time:</span>
                        <span class="metric-value" id="completion-time">0ms</span>
                    </div>
                    <div class="metric-item">
                        <span>Suggestions:</span>
                        <span class="metric-value" id="suggestion-count">0</span>
                    </div>
                    <div class="metric-item">
                        <span>Accuracy:</span>
                        <span class="metric-value" id="accuracy-rate">--</span>
                    </div>
                    <div class="metric-item">
                        <span>Memory Usage:</span>
                        <span class="metric-value" id="memory-usage">0 MB</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Actions</h3>
                    <button class="action-btn secondary-btn" onclick="formatCode()">Format Code</button>
                    <button class="action-btn secondary-btn" onclick="exportCode()">Export Code</button>
                    <button class="action-btn secondary-btn" onclick="clearEditor()">Clear Editor</button>
                    <button class="action-btn secondary-btn" onclick="shareCode()">Share Code</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { 
            TrustformersWasm, 
            InferenceSession, 
            WasmTensor,
            get_memory_stats
        } from '../pkg/trustformers_wasm.js';

        class CodeCompletionDemo {
            constructor() {
                this.session = null;
                this.isCompleting = false;
                this.currentLanguage = 'python';
                this.completionHistory = [];
                this.currentSuggestions = [];
                this.selectedSuggestion = 0;
                this.autoCompleteTimeout = null;
                
                this.initializeUI();
                this.initializeWasm();
                this.setupTemplates();
            }

            async initializeWasm() {
                try {
                    // Initialize TrustformeRS
                    const tf = new TrustformersWasm();
                    console.log('TrustformeRS Version:', tf.version);
                    
                    // Create inference session for code completion
                    this.session = new InferenceSession('code-completion');
                    
                    // Initialize with automatic device selection
                    await this.session.initialize_with_auto_device();
                    
                    // Load default model
                    await this.loadModel('codellama-7b');
                    
                    this.updateStatus();
                    
                } catch (error) {
                    console.error('Failed to initialize WASM:', error);
                    this.showError('Failed to initialize TrustformeRS: ' + error.message);
                }
            }

            async loadModel(modelId) {
                try {
                    const modelInfo = this.getModelInfo(modelId);
                    document.getElementById('model-status').textContent = `Model: Loading ${modelInfo.name}...`;
                    
                    // In a real implementation, you would load the actual code model
                    const mockModelData = new Uint8Array(modelInfo.size * 1024 * 1024);
                    await this.session.load_model(mockModelData);
                    
                    document.getElementById('model-status').textContent = `Model: ${modelInfo.name}`;
                    
                } catch (error) {
                    console.error('Failed to load model:', error);
                    this.showError('Failed to load model: ' + error.message);
                }
            }

            getModelInfo(modelId) {
                const models = {
                    'codellama-7b': { name: 'CodeLlama 7B', size: 13000 },
                    'codellama-13b': { name: 'CodeLlama 13B', size: 26000 },
                    'starcoder-15b': { name: 'StarCoder 15B', size: 30000 },
                    'deepseek-coder-6.7b': { name: 'DeepSeek Coder 6.7B', size: 13400 },
                    'qwen-coder-7b': { name: 'Qwen2.5-Coder 7B', size: 14000 },
                    'code-t5-plus': { name: 'CodeT5+ 770M', size: 1540 }
                };
                return models[modelId] || models['codellama-7b'];
            }

            initializeUI() {
                const editor = document.getElementById('code-editor');
                const languageSelector = document.getElementById('language-selector');
                
                // Language selector
                languageSelector.addEventListener('change', (e) => {
                    this.currentLanguage = e.target.value;
                    this.updatePlaceholder();
                    this.applySyntaxHighlighting();
                });
                
                // Editor events
                editor.addEventListener('input', this.handleEditorInput.bind(this));
                editor.addEventListener('keydown', this.handleKeyDown.bind(this));
                editor.addEventListener('scroll', this.updateLineNumbers.bind(this));
                
                // Action buttons
                document.getElementById('complete-btn').addEventListener('click', () => {
                    this.generateCompletion();
                });
                
                document.getElementById('explain-btn').addEventListener('click', () => {
                    this.explainCode();
                });
                
                document.getElementById('optimize-btn').addEventListener('click', () => {
                    this.optimizeCode();
                });
                
                // Model selector
                document.getElementById('model-select').addEventListener('change', (e) => {
                    this.loadModel(e.target.value);
                });
                
                // Settings
                this.setupSettings();
                
                // Template clicks
                document.querySelectorAll('.template-item').forEach(item => {
                    item.addEventListener('click', () => {
                        this.insertTemplate(item.dataset.template);
                    });
                });
                
                this.updateLineNumbers();
            }

            setupSettings() {
                // Temperature slider
                const tempSlider = document.getElementById('temperature-slider');
                const tempValue = document.getElementById('temperature-value');
                tempSlider.addEventListener('input', (e) => {
                    tempValue.textContent = e.target.value;
                });
                
                // Max length slider
                const lengthSlider = document.getElementById('max-length-slider');
                const lengthValue = document.getElementById('max-length-value');
                lengthSlider.addEventListener('input', (e) => {
                    lengthValue.textContent = e.target.value;
                });
                
                // Auto-completion checkbox
                document.getElementById('auto-complete').addEventListener('change', (e) => {
                    if (!e.target.checked) {
                        this.hideSuggestions();
                    }
                });
            }

            setupTemplates() {
                this.templates = {
                    'python-function': {
                        python: 'def function_name(param1, param2):\n    """\n    Description of the function.\n    """\n    # Implementation here\n    return result',
                        javascript: 'function functionName(param1, param2) {\n    // Implementation here\n    return result;\n}',
                        typescript: 'function functionName(param1: any, param2: any): any {\n    // Implementation here\n    return result;\n}',
                        rust: 'fn function_name(param1: Type1, param2: Type2) -> ReturnType {\n    // Implementation here\n    result\n}',
                        cpp: 'ReturnType functionName(Type1 param1, Type2 param2) {\n    // Implementation here\n    return result;\n}',
                        java: 'public ReturnType functionName(Type1 param1, Type2 param2) {\n    // Implementation here\n    return result;\n}',
                        go: 'func functionName(param1 Type1, param2 Type2) ReturnType {\n    // Implementation here\n    return result\n}',
                        sql: 'CREATE FUNCTION function_name(param1 TYPE, param2 TYPE)\nRETURNS RETURN_TYPE\nAS $$\nBEGIN\n    -- Implementation here\n    RETURN result;\nEND;\n$$ LANGUAGE plpgsql;'
                    },
                    'python-class': {
                        python: 'class ClassName:\n    def __init__(self, param1, param2):\n        self.param1 = param1\n        self.param2 = param2\n    \n    def method_name(self):\n        # Implementation here\n        pass',
                        javascript: 'class ClassName {\n    constructor(param1, param2) {\n        this.param1 = param1;\n        this.param2 = param2;\n    }\n    \n    methodName() {\n        // Implementation here\n    }\n}',
                        typescript: 'class ClassName {\n    private param1: Type1;\n    private param2: Type2;\n    \n    constructor(param1: Type1, param2: Type2) {\n        this.param1 = param1;\n        this.param2 = param2;\n    }\n    \n    methodName(): ReturnType {\n        // Implementation here\n        return result;\n    }\n}',
                        rust: 'struct ClassName {\n    param1: Type1,\n    param2: Type2,\n}\n\nimpl ClassName {\n    fn new(param1: Type1, param2: Type2) -> Self {\n        Self { param1, param2 }\n    }\n    \n    fn method_name(&self) -> ReturnType {\n        // Implementation here\n    }\n}',
                        cpp: 'class ClassName {\nprivate:\n    Type1 param1;\n    Type2 param2;\n    \npublic:\n    ClassName(Type1 param1, Type2 param2) : param1(param1), param2(param2) {}\n    \n    ReturnType methodName() {\n        // Implementation here\n        return result;\n    }\n};',
                        java: 'public class ClassName {\n    private Type1 param1;\n    private Type2 param2;\n    \n    public ClassName(Type1 param1, Type2 param2) {\n        this.param1 = param1;\n        this.param2 = param2;\n    }\n    \n    public ReturnType methodName() {\n        // Implementation here\n        return result;\n    }\n}',
                        go: 'type ClassName struct {\n    Param1 Type1\n    Param2 Type2\n}\n\nfunc NewClassName(param1 Type1, param2 Type2) *ClassName {\n    return &ClassName{\n        Param1: param1,\n        Param2: param2,\n    }\n}\n\nfunc (c *ClassName) MethodName() ReturnType {\n    // Implementation here\n    return result\n}',
                        sql: 'CREATE TABLE table_name (\n    id SERIAL PRIMARY KEY,\n    param1 VARCHAR(255) NOT NULL,\n    param2 INTEGER,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);'
                    },
                    'javascript-function': {
                        javascript: 'async function functionName(param1, param2) {\n    try {\n        // Implementation here\n        const result = await someAsyncOperation();\n        return result;\n    } catch (error) {\n        console.error("Error:", error);\n        throw error;\n    }\n}',
                        typescript: 'async function functionName(param1: Type1, param2: Type2): Promise<ReturnType> {\n    try {\n        // Implementation here\n        const result = await someAsyncOperation();\n        return result;\n    } catch (error) {\n        console.error("Error:", error);\n        throw error;\n    }\n}'
                    },
                    'rust-struct': {
                        rust: '#[derive(Debug, Clone)]\nstruct StructName {\n    field1: Type1,\n    field2: Type2,\n}\n\nimpl StructName {\n    fn new(field1: Type1, field2: Type2) -> Self {\n        Self { field1, field2 }\n    }\n    \n    fn method_name(&self) -> ReturnType {\n        // Implementation here\n    }\n}'
                    },
                    'sql-query': {
                        sql: 'SELECT \n    column1,\n    column2,\n    COUNT(*) as count\nFROM table_name\nWHERE condition = ?\nGROUP BY column1, column2\nHAVING COUNT(*) > 1\nORDER BY count DESC\nLIMIT 10;'
                    }
                };
            }

            handleEditorInput(e) {
                this.updateLineNumbers();
                
                if (document.getElementById('syntax-highlighting').checked) {
                    this.applySyntaxHighlighting();
                }
                
                if (document.getElementById('auto-complete').checked) {
                    clearTimeout(this.autoCompleteTimeout);
                    this.autoCompleteTimeout = setTimeout(() => {
                        this.triggerAutoComplete();
                    }, 500);
                }
            }

            handleKeyDown(e) {
                const popup = document.getElementById('suggestion-popup');
                
                if (popup.style.display === 'block') {
                    switch (e.key) {
                        case 'ArrowDown':
                            e.preventDefault();
                            this.navigateSuggestions(1);
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            this.navigateSuggestions(-1);
                            break;
                        case 'Tab':
                        case 'Enter':
                            e.preventDefault();
                            this.acceptSuggestion();
                            break;
                        case 'Escape':
                            this.hideSuggestions();
                            break;
                    }
                }
                
                if (e.key === 'Tab' && !e.shiftKey && popup.style.display !== 'block') {
                    e.preventDefault();
                    this.insertTab();
                }
            }

            updateLineNumbers() {
                const editor = document.getElementById('code-editor');
                const lineNumbers = document.getElementById('line-numbers');
                const lines = editor.value.split('\n').length;
                
                lineNumbers.innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('\n');
            }

            updatePlaceholder() {
                const editor = document.getElementById('code-editor');
                const placeholders = {
                    python: 'def hello_world():\n    print("Hello, World!")',
                    javascript: 'function helloWorld() {\n    console.log("Hello, World!");\n}',
                    typescript: 'function helloWorld(): void {\n    console.log("Hello, World!");\n}',
                    rust: 'fn hello_world() {\n    println!("Hello, World!");\n}',
                    cpp: '#include <iostream>\n\nint main() {\n    std::cout << "Hello, World!" << std::endl;\n    return 0;\n}',
                    java: 'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello, World!");\n    }\n}',
                    go: 'package main\n\nimport "fmt"\n\nfunc main() {\n    fmt.Println("Hello, World!")\n}',
                    sql: 'SELECT "Hello, World!" as message;'
                };
                
                editor.placeholder = placeholders[this.currentLanguage] || 'Start typing your code here...';
            }

            insertTemplate(templateKey) {
                const editor = document.getElementById('code-editor');
                const template = this.templates[templateKey];
                
                if (template && template[this.currentLanguage]) {
                    const cursorPos = editor.selectionStart;
                    const text = editor.value;
                    const beforeCursor = text.substring(0, cursorPos);
                    const afterCursor = text.substring(cursorPos);
                    
                    editor.value = beforeCursor + template[this.currentLanguage] + afterCursor;
                    this.updateLineNumbers();
                }
            }

            insertTab() {
                const editor = document.getElementById('code-editor');
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                
                editor.value = editor.value.substring(0, start) + '    ' + editor.value.substring(end);
                editor.selectionStart = editor.selectionEnd = start + 4;
            }

            async triggerAutoComplete() {
                if (this.isCompleting) return;
                
                const editor = document.getElementById('code-editor');
                const cursorPos = editor.selectionStart;
                const text = editor.value;
                const beforeCursor = text.substring(0, cursorPos);
                
                // Simple heuristic to trigger completion
                const lines = beforeCursor.split('\n');
                const currentLine = lines[lines.length - 1];
                
                if (currentLine.trim().length > 2) {
                    await this.generateSuggestions(beforeCursor);
                }
            }

            async generateCompletion() {
                if (this.isCompleting) return;
                
                const editor = document.getElementById('code-editor');
                const cursorPos = editor.selectionStart;
                const text = editor.value;
                const beforeCursor = text.substring(0, cursorPos);
                const afterCursor = text.substring(cursorPos);
                
                this.isCompleting = true;
                this.updateProgress(0);
                
                try {
                    const startTime = Date.now();
                    
                    // Generate completion
                    const completion = await this.simulateCompletion(beforeCursor, afterCursor);
                    
                    // Insert completion
                    editor.value = beforeCursor + completion + afterCursor;
                    editor.selectionStart = editor.selectionEnd = cursorPos + completion.length;
                    
                    // Update metrics
                    const duration = Date.now() - startTime;
                    this.updateMetrics(duration, completion);
                    
                    this.updateLineNumbers();
                    this.updateProgress(100);
                    
                } catch (error) {
                    console.error('Completion failed:', error);
                    this.showError('Completion failed: ' + error.message);
                } finally {
                    this.isCompleting = false;
                }
            }

            async generateSuggestions(context) {
                try {
                    const suggestions = await this.simulateSuggestions(context);
                    this.showSuggestions(suggestions);
                } catch (error) {
                    console.error('Failed to generate suggestions:', error);
                }
            }

            async simulateCompletion(beforeCursor, afterCursor) {
                // Simulate model processing time
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const fillInMiddle = document.getElementById('fill-in-middle').checked;
                const multiLine = document.getElementById('multi-line').checked;
                const maxLength = parseInt(document.getElementById('max-length-slider').value);
                
                const completions = {
                    python: [
                        '\n    return result',
                        '\n    pass',
                        '\n    raise NotImplementedError("TODO: implement this method")',
                        'print("Hello, World!")',
                        'for i in range(10):\n        print(i)',
                        'if condition:\n        return True\n    else:\n        return False'
                    ],
                    javascript: [
                        '\n    return result;',
                        '\n    console.log("Debug:", value);',
                        'const result = await fetch(url);',
                        'if (condition) {\n        return true;\n    }',
                        'for (let i = 0; i < array.length; i++) {\n        console.log(array[i]);\n    }'
                    ],
                    rust: [
                        '\n    Ok(result)',
                        '\n    todo!("implement this")',
                        'println!("Debug: {:?}", value);',
                        'if condition {\n        return Ok(());\n    }',
                        'for item in items.iter() {\n        println!("{:?}", item);\n    }'
                    ],
                    sql: [
                        '\nORDER BY created_at DESC;',
                        '\nWHERE id = ?;',
                        'SELECT * FROM table_name',
                        'GROUP BY column_name\nHAVING COUNT(*) > 1'
                    ]
                };
                
                const langCompletions = completions[this.currentLanguage] || completions.python;
                let completion = langCompletions[Math.floor(Math.random() * langCompletions.length)];
                
                if (!multiLine) {
                    completion = completion.split('\n')[0];
                }
                
                return completion.substring(0, maxLength);
            }

            async simulateSuggestions(context) {
                // Simulate model processing time
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const suggestions = [
                    {
                        title: 'print()',
                        description: 'Print output to console',
                        type: 'function',
                        insertText: 'print()'
                    },
                    {
                        title: 'len()',
                        description: 'Return the length of an object',
                        type: 'function',
                        insertText: 'len()'
                    },
                    {
                        title: 'range()',
                        description: 'Create a sequence of numbers',
                        type: 'function',
                        insertText: 'range()'
                    },
                    {
                        title: 'result',
                        description: 'Local variable',
                        type: 'variable',
                        insertText: 'result'
                    },
                    {
                        title: 'return',
                        description: 'Return statement',
                        type: 'keyword',
                        insertText: 'return '
                    }
                ];
                
                return suggestions.slice(0, 3); // Return top 3 suggestions
            }

            showSuggestions(suggestions) {
                const popup = document.getElementById('suggestion-popup');
                const editor = document.getElementById('code-editor');
                
                if (suggestions.length === 0) {
                    this.hideSuggestions();
                    return;
                }
                
                this.currentSuggestions = suggestions;
                this.selectedSuggestion = 0;
                
                popup.innerHTML = '';
                suggestions.forEach((suggestion, index) => {
                    const item = document.createElement('div');
                    item.className = `suggestion-item ${index === 0 ? 'selected' : ''}`;
                    item.innerHTML = `
                        <div class="suggestion-title">
                            ${suggestion.title}
                            <span class="suggestion-type type-${suggestion.type}">${suggestion.type}</span>
                        </div>
                        <div class="suggestion-description">${suggestion.description}</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.selectedSuggestion = index;
                        this.acceptSuggestion();
                    });
                    
                    popup.appendChild(item);
                });
                
                // Position popup near cursor
                const rect = editor.getBoundingClientRect();
                popup.style.display = 'block';
                popup.style.left = '100px';
                popup.style.top = '50px';
                
                document.getElementById('suggestion-count').textContent = suggestions.length;
            }

            navigateSuggestions(direction) {
                if (this.currentSuggestions.length === 0) return;
                
                this.selectedSuggestion += direction;
                if (this.selectedSuggestion < 0) {
                    this.selectedSuggestion = this.currentSuggestions.length - 1;
                } else if (this.selectedSuggestion >= this.currentSuggestions.length) {
                    this.selectedSuggestion = 0;
                }
                
                // Update visual selection
                const items = document.querySelectorAll('.suggestion-item');
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === this.selectedSuggestion);
                });
            }

            acceptSuggestion() {
                if (this.currentSuggestions.length === 0) return;
                
                const suggestion = this.currentSuggestions[this.selectedSuggestion];
                const editor = document.getElementById('code-editor');
                const cursorPos = editor.selectionStart;
                
                // Find the start of the current word
                const text = editor.value;
                let wordStart = cursorPos;
                while (wordStart > 0 && /\w/.test(text[wordStart - 1])) {
                    wordStart--;
                }
                
                // Replace current word with suggestion
                const beforeWord = text.substring(0, wordStart);
                const afterCursor = text.substring(cursorPos);
                
                editor.value = beforeWord + suggestion.insertText + afterCursor;
                editor.selectionStart = editor.selectionEnd = wordStart + suggestion.insertText.length;
                
                this.hideSuggestions();
                this.updateLineNumbers();
            }

            hideSuggestions() {
                document.getElementById('suggestion-popup').style.display = 'none';
                this.currentSuggestions = [];
                this.selectedSuggestion = 0;
            }

            async explainCode() {
                const editor = document.getElementById('code-editor');
                const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
                const codeToExplain = selectedText || editor.value;
                
                if (!codeToExplain.trim()) {
                    this.showError('No code to explain');
                    return;
                }
                
                alert(`Code Explanation:\n\nThis ${this.currentLanguage} code appears to implement a function or script. In a real implementation, this would provide detailed analysis of the code structure, purpose, and functionality.`);
            }

            async optimizeCode() {
                const editor = document.getElementById('code-editor');
                const code = editor.value;
                
                if (!code.trim()) {
                    this.showError('No code to optimize');
                    return;
                }
                
                alert(`Code Optimization Suggestions:\n\n1. Consider using more descriptive variable names\n2. Add error handling where appropriate\n3. Break down complex functions into smaller ones\n4. Add type hints (for Python/TypeScript)\n5. Use consistent formatting\n\nIn a real implementation, this would provide specific optimization suggestions based on the actual code.`);
            }

            updateMetrics(duration, completion) {
                document.getElementById('completion-time').textContent = `${duration}ms`;
                
                // Update memory usage
                if (this.session) {
                    const memStats = get_memory_stats();
                    const memoryMB = Math.round(memStats.wasm_memory / 1024 / 1024);
                    document.getElementById('memory-usage').textContent = `${memoryMB} MB`;
                    document.getElementById('memory-info').textContent = `Memory: ${memoryMB} MB`;
                }
                
                // Simulate accuracy rate
                const accuracy = 85 + Math.random() * 10;
                document.getElementById('accuracy-rate').textContent = `${accuracy.toFixed(1)}%`;
            }

            updateStatus() {
                if (this.session) {
                    const deviceType = this.session.current_device_type || 'CPU';
                    document.getElementById('device-info').textContent = `Device: ${deviceType}`;
                }
            }

            updateProgress(percentage) {
                document.getElementById('progress-fill').style.width = `${percentage}%`;
                
                if (percentage === 0) {
                    document.getElementById('completion-stats').textContent = 'Generating completion...';
                } else if (percentage === 100) {
                    document.getElementById('completion-stats').textContent = 'Completion ready';
                }
            }

            applySyntaxHighlighting() {
                // In a real implementation, this would apply proper syntax highlighting
                // For demo purposes, we'll keep it simple
                console.log('Syntax highlighting applied');
            }

            showError(message) {
                alert(message); // In production, use a proper notification system
            }
        }

        // Global functions for UI interactions
        window.formatCode = function() {
            const editor = document.getElementById('code-editor');
            const code = editor.value;
            
            if (!code.trim()) {
                alert('No code to format');
                return;
            }
            
            // Simple formatting (in real implementation, use proper formatters)
            const formatted = code.replace(/\t/g, '    '); // Convert tabs to spaces
            editor.value = formatted;
            
            alert('Code formatted! (In a real implementation, this would use language-specific formatters)');
        };

        window.exportCode = function() {
            const editor = document.getElementById('code-editor');
            const language = document.getElementById('language-selector').value;
            const code = editor.value;
            
            if (!code.trim()) {
                alert('No code to export');
                return;
            }
            
            const extensions = {
                python: 'py',
                javascript: 'js',
                typescript: 'ts',
                rust: 'rs',
                cpp: 'cpp',
                java: 'java',
                go: 'go',
                sql: 'sql'
            };
            
            const extension = extensions[language] || 'txt';
            const filename = `code.${extension}`;
            
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.clearEditor = function() {
            document.getElementById('code-editor').value = '';
            document.getElementById('line-numbers').innerHTML = '1';
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('completion-stats').textContent = 'Ready for code completion';
        };

        window.shareCode = function() {
            const editor = document.getElementById('code-editor');
            const code = editor.value;
            
            if (!code.trim()) {
                alert('No code to share');
                return;
            }
            
            if (navigator.share) {
                navigator.share({
                    title: 'Code Snippet',
                    text: code
                });
            } else {
                navigator.clipboard.writeText(code);
                alert('Code copied to clipboard!');
            }
        };

        // Initialize the demo
        const demo = new CodeCompletionDemo();
        
        // Make demo available globally for debugging
        window.demo = demo;
    </script>
</body>
</html>