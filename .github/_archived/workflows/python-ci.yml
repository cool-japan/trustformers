name: Python CI/CD

on:
  push:
    branches: [main, master, develop]
    paths: 
      - 'trustformers-py/**'
      - '.github/workflows/python-ci.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'trustformers-py/**'
      - '.github/workflows/python-ci.yml'
  schedule:
    # Run nightly at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  PACKAGE_PATH: trustformers-py
  PYTHON_PACKAGE_NAME: trustformers

defaults:
  run:
    working-directory: trustformers-py

jobs:
  # Lint and format checks
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-

      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 mypy bandit pylint ruff

      - name: Check code formatting with black
        run: black --check --diff python/

      - name: Check import sorting with isort
        run: isort --check-only --diff python/

      - name: Lint with flake8
        run: flake8 python/ --max-line-length=88 --extend-ignore=E203,W503

      - name: Lint with ruff (modern fast linter)
        run: ruff check python/

      - name: Security check with bandit
        run: bandit -r python/ -f json -o bandit-report.json
        continue-on-error: true

      - name: Upload bandit report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: bandit-security-report
          path: trustformers-py/bandit-report.json

      - name: Type checking with mypy
        run: mypy python/trustformers --ignore-missing-imports
        continue-on-error: true

  # Test matrix across Python versions and platforms
  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        os: [ubuntu-latest, windows-latest, macos-latest]
        exclude:
          # Reduce matrix size for faster builds
          - os: windows-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.8'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}

      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config cmake

      - name: Install system dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install cmake

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pytest-xdist maturin

      - name: Install optional dependencies for comprehensive testing
        run: |
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install jax jaxlib
          pip install fastapi uvicorn prometheus-client
          pip install mlflow wandb tensorboard
          pip install pandas scikit-learn matplotlib seaborn plotly
          pip install jupyter ipywidgets tqdm
        continue-on-error: true

      - name: Build Rust extension
        run: |
          maturin develop --release

      - name: Run basic tests
        run: |
          python -m pytest tests/ -v --tb=short --maxfail=10

      - name: Run tests with coverage
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        run: |
          python -m pytest tests/ --cov=python/trustformers --cov-report=xml --cov-report=html -v

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v3
        with:
          file: ./trustformers-py/coverage.xml
          flags: python
          name: python-${{ matrix.python-version }}-${{ matrix.os }}

  # Build wheels for different platforms
  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cibuildwheel
        run: python -m pip install cibuildwheel==2.16.*

      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        working-directory: trustformers-py
        env:
          # Build for multiple Python versions
          CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-*"
          # Skip 32-bit builds and PyPy for now
          CIBW_SKIP: "*-win32 *-manylinux_i686 pp*"
          # Install Rust in the build environment
          CIBW_BEFORE_ALL_LINUX: "curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain stable -y && source ~/.cargo/env"
          CIBW_BEFORE_ALL_MACOS: "curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain stable -y && source ~/.cargo/env"
          CIBW_BEFORE_ALL_WINDOWS: "curl -sSf -o rustup-init.exe https://win.rustup.rs && rustup-init.exe -y --default-toolchain stable"
          # Build command
          CIBW_BUILD_COMMAND: "pip install maturin && maturin build --release"
          # Test command
          CIBW_TEST_COMMAND: "python -c 'import trustformers; print(trustformers.__version__)'"
          # Environment variables
          CIBW_ENVIRONMENT_LINUX: "PATH=$HOME/.cargo/bin:$PATH"
          CIBW_ENVIRONMENT_MACOS: "PATH=$HOME/.cargo/bin:$PATH"
          CIBW_ENVIRONMENT_WINDOWS: "PATH=$USERPROFILE\\.cargo\\bin;$PATH"

      - name: Upload wheels
        uses: actions/upload-artifact@v3
        with:
          name: wheels-${{ matrix.os }}
          path: trustformers-py/wheelhouse/*.whl

  # Build source distribution
  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install maturin build

      - name: Build source distribution
        run: |
          maturin sdist
          
      - name: Upload sdist
        uses: actions/upload-artifact@v3
        with:
          name: sdist
          path: trustformers-py/target/wheels/*.tar.gz

  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit semgrep

      - name: Run safety check
        run: |
          pip freeze | safety check --json --output safety-report.json
        continue-on-error: true

      - name: Run bandit security check
        run: |
          bandit -r python/ -f json -o bandit-report.json
        continue-on-error: true

      - name: Run semgrep
        run: |
          semgrep --config=auto python/ --json --output=semgrep-report.json
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: |
            trustformers-py/safety-report.json
            trustformers-py/bandit-report.json
            trustformers-py/semgrep-report.json

  # Dependency analysis
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: python -m pip install pip-audit

      - name: Check dependencies for known vulnerabilities
        run: |
          pip-audit --format=json --output=pip-audit-report.json .
        continue-on-error: true

      - name: Upload dependency report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: dependency-report
          path: trustformers-py/pip-audit-report.json

  # Performance benchmarks
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install maturin pytest-benchmark

      - name: Build current version
        run: maturin develop --release

      - name: Run benchmarks
        run: |
          python -m pytest tests/ -k "benchmark" --benchmark-json=benchmark-results.json
        continue-on-error: true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: trustformers-py/benchmark-results.json

  # Documentation build
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install maturin sphinx sphinx-rtd-theme myst-parser
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install jax jaxlib

      - name: Build extension
        run: maturin develop --release

      - name: Build documentation
        run: |
          # Create basic docs structure if it doesn't exist
          if [ ! -d "docs" ]; then
            sphinx-quickstart -q -p "TrustformeRS" -a "TrustformeRS Team" --ext-autodoc --ext-viewcode docs
          fi
          sphinx-build -b html docs docs/_build
        continue-on-error: true

      - name: Upload documentation
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: documentation
          path: trustformers-py/docs/_build/

  # Integration tests with external services
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install maturin pytest
          pip install fastapi uvicorn prometheus-client
          pip install torch --index-url https://download.pytorch.org/whl/cpu

      - name: Build extension
        run: maturin develop --release

      - name: Run integration tests
        run: |
          python -m pytest tests/test_serving.py -v -k "not test_load_model" --tb=short
        continue-on-error: true

  # Final status check
  ci-status:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [lint, test, build-wheels, build-sdist, security]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          if [[ "${{ needs.lint.result }}" != "success" || \
                "${{ needs.test.result }}" != "success" || \
                "${{ needs.build-wheels.result }}" != "success" || \
                "${{ needs.build-sdist.result }}" != "success" || \
                "${{ needs.security.result }}" != "success" ]]; then
            echo "One or more required checks failed"
            echo "Lint: ${{ needs.lint.result }}"
            echo "Test: ${{ needs.test.result }}"
            echo "Build Wheels: ${{ needs.build-wheels.result }}"
            echo "Build Sdist: ${{ needs.build-sdist.result }}"
            echo "Security: ${{ needs.security.result }}"
            exit 1
          fi
          echo "All required checks passed!"